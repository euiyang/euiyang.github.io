# 3부  
# Windows 메세지 후킹(21)  
훅이란 정보를 엿보거나 가로채는 것을 의미하고 실제로 하는 행위를 후킹이라한다.  

메세지 훅:  
windows는 GUI를 제공하고 event driven 방식으로 동작한다. 다양한 이벤트가 발생하면 OS가 응용 프로그램으로 메시지를 전송하는데,  
이러한 메시지를 훅하는 것이 메시지 훅이라 부른다.  

일반적인 경우 Windows 메시지 흐름:
1) 이벤트 발생-> WM_KEYDOWM 메시지가 OS message queue에 추가된다
2) OS가 어느 응용 프로그램에서 이벤트가 발생한지 파악해서 OS message queue-> application message queue로 이동  
3) 응용 프로그램이 WM_KEYDOWN 메시지 확인하고 event handler 호출  

하지만 메시지 훅이 설치 되었으면 OS에서 application으로 가는 도중에 훅 체인에서 메시지를 먼저 볼 수 있으며, 엿보기 뿐만  
아니라 메시지 자체의 변경, 전송 불가도 가능하다. 이러한 메시지 훅 기능은 window OS에서 기본으로 제공하며, OS에서 오고가는  
모든 메시지를 볼 수 있다.  


SetWindwosHookEx() 함수:  
![image](https://user-images.githubusercontent.com/65746019/120029343-f10c2400-c030-11eb-90f1-e0e8ea2feba5.png)  

이 함수를 이용해서 훅을 설치하면, 메시지가 발생했을 때 OS가 해당 DLL 파일을 해당 프로세스에 인젝션하고 훅을 호출한다.  

위 함수를 사용한 프로그램 코드를 보면  
![image](https://user-images.githubusercontent.com/65746019/120034308-d7baa600-c037-11eb-994a-a8dddc718c0b.png)  
![image](https://user-images.githubusercontent.com/65746019/120034331-e012e100-c037-11eb-8459-9a9a3e4b6446.png)  
위와 같이 KeyHook.dll을 불러와서 시작과 종료를 하는 간단한 프로그램이다.  

KeyHook.dll 파일 내부도 간단히 요약하면 실행하면 키보드 이벤트 발생 시에 실행 프로세스의 이름이 등록한 문자열과 같으면  
메시지를 가로채는 것이다.  

훅 코드 디버깅:  
KeyHook.dll의 HookStart() 함수 부분을 보면
![image](https://user-images.githubusercontent.com/65746019/120036015-73e5ac80-c03a-11eb-8813-c60dee8dfb1f.png)  
SetWindowsHookEX의 인자에 PUSH로 10001020과 2를 넣으므로  
idHook=2  
lpfn=10001020  
가 된다. 이 부분을 벗어나면 단순하게 q를 받으면 종료되는 부분이니 넘어간다.  
notepad를 디버깅 해보는 것은 다음에 해보자. (설정에서 dll 접근시 멈춤 켜놓으면 멈춘다.)  


# 악의적인 목적의 키로거(22)  
조심하자  


# DLL 인젝션  






